<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BIWI - Tableau de bord (School)</title>

  <!-- Font Awesome + Chart.js -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    /* ---------- Theme variables (default: light academic) ---------- */
    :root{
      --bg: #f6f7f9;
      --sidebar: #ffffff;
      --panel: #ffffff;
      --muted: #6b7280;
      --accent: #0b74da;
      --text: #0f1723;
      --border: rgba(15,23,35,0.06);
      --card-radius: 12px;
      --shadow: 0 6px 18px rgba(15,23,35,0.06);
      --glass-bg: rgba(255,255,255,0.65);
    }
    /* Dark theme variables (applied by .dark on body) */
    body.dark {
      --bg: #071226;
      --sidebar: #081827;
      --panel: #0f2430;
      --muted: #9fb0bb;
      --accent: #00c2a8;
      --text: #e8f6f6;
      --border: rgba(255,255,255,0.04);
      --shadow: 0 8px 24px rgba(0,0,0,0.45);
      --glass-bg: rgba(8,24,39,0.6);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:Inter, system-ui, "Helvetica Neue", Arial, sans-serif;
      background:var(--bg);
      color:var(--text);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      transition:background .25s ease,color .25s ease;
    }

    /* Layout */
    .app{display:flex;min-height:100vh}
    .sidebar{
      width:260px;
      background:linear-gradient(180deg,var(--sidebar),#fff);
      padding:18px;
      border-right:1px solid var(--border);
      transition:left .22s ease,background .25s ease;
      box-shadow: var(--shadow);
    }
    body.dark .sidebar{background:linear-gradient(180deg,var(--sidebar),#021016)}
    .brand{display:flex;align-items:center;gap:12px;margin-bottom:18px}
    .brand i{font-size:26px;color:var(--accent)}
    .brand h1{margin:0;font-size:18px;color:var(--text);letter-spacing:1px}
    nav.nav{margin-top:12px}
    nav.nav button{
      width:100%;display:flex;align-items:center;gap:12px;padding:10px;border-radius:8px;border:none;
      background:transparent;color:rgba(15,23,35,0.9);font-weight:700;cursor:pointer;text-align:left;
    }
    body.dark nav.nav button{color:rgba(232,246,246,0.95)}
    nav.nav button:hover{background:rgba(11,116,218,0.06)}
    nav.nav button.active{background:linear-gradient(90deg,rgba(11,116,218,0.12),rgba(11,116,218,0.03));border-left:3px solid var(--accent)}
    nav.nav i{width:20px;text-align:center;color:var(--muted)}

    .sidebar .support{margin-top:18px;font-size:13px;color:var(--muted)}

    .main{flex:1;padding:22px;overflow:auto}
    .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px;gap:12px}
    .title h2{margin:0;color:var(--accent)}
    .title small{color:var(--muted)}
    .user{display:flex;align-items:center;gap:12px}
    .avatar{width:44px;height:44px;border-radius:8px;object-fit:cover;border:2px solid rgba(0,0,0,0.06)}

    .hamburger{display:none;background:none;border:none;font-size:22px;color:var(--accent);cursor:pointer;margin-right:8px}
    @media(max-width:980px){
      .sidebar{position:fixed;left:-320px;top:0;height:100vh;z-index:999}
      .sidebar.open{left:0}
      .hamburger{display:inline-block}
      .main{padding:14px}
    }

    .card{background:var(--panel);padding:14px;border-radius:var(--card-radius);border:1px solid var(--border);box-shadow:var(--shadow);transition:background .25s ease}
    .cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:14px;margin-bottom:14px}

    form label{display:block;margin-bottom:6px;color:var(--muted);font-size:13px}
    form input, form select, form button{
      width:100%;padding:10px;border-radius:8px;border:1px solid var(--border);background:transparent;color:var(--text);
      font-size:14px;
    }
    .form-row{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
    .form-row.single{grid-template-columns:1fr}
    .btn{display:inline-block;margin-top:10px;padding:10px 14px;background:var(--accent);color:#fff;border-radius:8px;font-weight:800;text-decoration:none;border:none;cursor:pointer}

    /* Table */
    .clients{background:var(--panel);padding:12px;border-radius:10px;border:1px solid var(--border);overflow:auto}
    table{width:100%;border-collapse:collapse;color:var(--text);min-width:920px}
    th,td{padding:10px;border-bottom:1px solid rgba(15,23,35,0.04);font-size:14px;text-align:left}
    th{color:var(--muted);font-weight:700;position:sticky;top:0;background:linear-gradient(180deg,rgba(255,255,255,0.98),transparent)}
    body.dark th{background:linear-gradient(180deg,rgba(0,0,0,0.06),transparent)}
    tr:hover td{background:rgba(11,116,218,0.03)}
    tr.clickable{cursor:pointer}
    .tag{display:inline-block;padding:6px 8px;border-radius:999px;background:rgba(11,116,218,0.06);font-weight:700;color:var(--muted);font-size:12px}

    .search-row{display:flex;gap:8px;align-items:center;margin-bottom:12px}
    .search-row input{flex:1;padding:10px;border-radius:8px;border:1px solid var(--border);background:transparent;color:var(--text)}

    /* Param switches */
    .switch {position:relative;display:inline-block;width:52px;height:28px}
    .switch input{display:none}
    .slider {position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:#ccc;border-radius:34px;transition:.2s}
    .slider:before{position:absolute;content:"";height:22px;width:22px;left:3px;top:3px;background:white;border-radius:50%;transition:.2s}
    input:checked + .slider{background:var(--accent)}
    input:checked + .slider:before{transform:translateX(24px)}

    @media(max-width:700px){
      table{min-width:600px}
    }
    @media(max-width:520px){
      .form-row{grid-template-columns:1fr}
      table{min-width:520px}
    }

    footer{color:var(--muted);margin-top:18px}
    .count-badge{font-weight:800;color:var(--accent);margin-bottom:8px;display:inline-block}
    .small-muted{color:var(--muted);font-size:13px}

    /* Modal - glass style */
    .overlay{
      position:fixed;inset:0;background:rgba(2,6,23,0.35);backdrop-filter:blur(6px);display:none;align-items:center;justify-content:center;z-index:2000;
      transition:opacity .18s ease;
    }
    .overlay.open{display:flex;opacity:1}
    .modal{
      width:720px;max-width:95%;border-radius:14px;padding:18px;background:var(--glass-bg);box-shadow:0 20px 60px rgba(2,6,23,0.4);color:var(--text);backdrop-filter:blur(6px);
      transform:translateY(-6px);transition:transform .18s ease,opacity .18s ease;
    }
    .modal h3{margin:0 0 6px 0;color:var(--accent)}
    .modal .row{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:8px}
    .modal label{display:block;color:var(--muted);font-size:13px;margin-bottom:6px}
    .modal input{width:100%;padding:8px;border-radius:8px;border:1px solid var(--border);background:transparent;color:var(--text)}
    .modal .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
    .btn-ghost{background:transparent;border:1px solid var(--border);padding:8px 12px;border-radius:8px;color:var(--text);cursor:pointer}
    .btn-danger{background:#ef4444;color:#fff;border:none;padding:10px 12px;border-radius:8px;cursor:pointer}
    .btn-save{background:#10b981;color:#fff;border:none;padding:10px 12px;border-radius:8px;cursor:pointer}

    /* Toast */
    .toast{
      position:fixed;right:20px;bottom:24px;padding:12px 16px;border-radius:10px;background:rgba(0,0,0,0.85);color:white;z-index:3000;display:none;
      box-shadow:0 8px 24px rgba(0,0,0,0.4);
    }
    .toast.show{display:block;animation:toastIn .25s ease;}
    @keyframes toastIn{from{transform:translateY(8px);opacity:0}to{transform:translateY(0);opacity:1}}

    /* Notes popup card (small custom window) */
    .notes-popup{
      position:fixed;
      right:20px;
      bottom:80px;
      z-index:2600;
      display:none;
      width:360px;
      max-width:calc(100% - 40px);
    }
    .notes-popup.open{display:block}
    .notes-card{
      background:var(--panel);
      border-radius:12px;
      padding:12px;
      border:1px solid var(--border);
      box-shadow:var(--shadow);
    }
    .notes-card h4{margin:0 0 8px 0;color:var(--accent)}
    .notes-card .notes-year{padding:8px;border-radius:8px;background:rgba(11,116,218,0.03);margin-bottom:8px}
    .notes-card .subject{font-size:14px;margin-bottom:4px}
    .notes-card .result{font-weight:800;margin-top:6px}
    .notes-close{position:absolute;top:8px;right:8px;border:none;background:transparent;cursor:pointer;color:var(--muted)}

    /* small tweaks for notes button in table */
    .notes-table-btn{padding:6px 8px;border-radius:8px;border:1px solid var(--border);background:transparent;cursor:pointer}
  </style>
</head>
<body>
  <div class="app" id="app">
    <!-- SIDEBAR -->
    <aside class="sidebar" id="sidebar" aria-label="Navigation principale">
      <div class="brand" role="banner">
        <i class="fas fa-school"></i>
        <h1>BIWI</h1>
      </div>

      <nav class="nav" role="navigation" aria-label="Menu principal">
        <button class="active" data-section="dashboard"><i class="fas fa-tachometer-alt"></i> Dashboard</button>
        <button data-section="inscription"><i class="fas fa-user-plus"></i> Inscription</button>
        <button data-section="listes"><i class="fas fa-list"></i> Listes</button>
        <!-- NEW Notes button inserted after Listes -->
        <button data-section="notes"><i class="fas fa-sticky-note"></i> Notes</button>
        <button data-section="recherche"><i class="fas fa-search"></i> Recherche</button>
        <button data-section="parametres"><i class="fas fa-sliders-h"></i> Paramètres</button>
      </nav>

      <div class="support">
        <strong>Contact</strong><br>
        <small class="small-muted">info@biwi.school • Port-au-Prince, Haiti</small>
      </div>
    </aside>

    <!-- MAIN -->
    <main class="main" id="main">
      <div class="topbar" role="toolbar" aria-label="Barre supérieure">
        <div style="display:flex;align-items:center;gap:12px">
          <button class="hamburger" id="hamburger" aria-label="Ouvrir le menu"><i class="fas fa-bars"></i></button>
          <div class="title"><h2>Dashboard</h2><small class="small-muted">BIWI — Port-au-Prince</small></div>
        </div>

        <div class="user" aria-label="Informations utilisateur">
          <div style="text-align:right">
            <div style="font-weight:700">BIWI Admin</div>
            <small class="small-muted">Tableau d'administration</small>
          </div>
          <img class="avatar" src="https://ui-avatars.com/api/?name=BIWI+Admin&background=0b74da&color=fff" alt="Avatar admin">
        </div>
      </div>

      <!-- ===== DASHBOARD ===== -->
      <section id="dashboard-content" class="content-section" style="display:block">
        <div class="cards" style="margin-bottom:14px">
          <div class="card">
            <h3 style="margin:0 0 8px 0;color:var(--accent)">BIWI — Business Institute</h3>
            <p class="small-muted" style="margin:0 0 10px 0">Adresse : Rue Capois, Bourdon, Port-au-Prince, Haiti</p>
            <p class="small-muted" style="margin:0 0 8px 0">Téléphone : +509 37-000-000</p>
            <p style="margin-top:10px;color:var(--muted)">BIWI est une école située à Port-au-Prince. Sur ce tableau vous verrez la répartition des élèves par cours, section et adresse.</p>
          </div>

          <div class="card">
            <h3 style="margin:0 0 8px 0;color:var(--accent)">Résumé rapide</h3>
            <div style="display:flex;gap:12px;flex-wrap:wrap">
              <div style="min-width:140px">
                <div class="small-muted">Élèves totaux</div>
                <div id="dashboardTotal" style="font-weight:800;font-size:20px;margin-top:6px">0</div>
              </div>
              <div style="min-width:140px">
                <div class="small-muted">Sections</div>
                <div id="dashboardSections" style="font-weight:800;font-size:20px;margin-top:6px">A,B,C,D</div>
              </div>
            </div>
          </div>
        </div>

        <div class="cards" style="grid-template-columns:repeat(auto-fit,minmax(320px,1fr));margin-bottom:12px">
          <div class="card">
            <h4 style="color:var(--accent);margin:0 0 8px 0">Répartition par Cours</h4>
            <canvas id="courseChart" aria-label="Graphique des cours"></canvas>
          </div>
          <div class="card">
            <h4 style="color:var(--accent);margin:0 0 8px 0">Répartition par Section</h4>
            <canvas id="sectionChart" aria-label="Graphique des sections"></canvas>
          </div>
          <div class="card">
            <h4 style="color:var(--accent);margin:0 0 8px 0">Répartition par Adresse</h4>
            <canvas id="addressChart" aria-label="Graphique des adresses"></canvas>
          </div>
        </div>
      </section>

      <!-- ===== INSCRIPTION ===== -->
      <section id="inscription-content" class="content-section" style="display:none">
        <div class="cards" style="margin-bottom:16px;">
          <div class="card">
            <h3 style="margin:0 0 8px 0;color:var(--accent)">Formulaire d'inscription</h3>
            <p class="small-muted" style="margin:0 0 12px 0">Ajoutez un nouvel élève — l'inscription sera envoyée à la liste.</p>

            <form id="inscriptionForm" aria-label="Formulaire d'inscription">
              <div class="form-row">
                <div>
                  <label for="section">Section</label>
                  <select id="section" required>
                    <option value="A">A</option>
                    <option value="B">B</option>
                    <option value="C">C</option>
                    <option value="D">D</option>
                  </select>
                </div>

                <div>
                  <label for="cours">Cours</label>
                  <select id="cours" required>
                    <option>Mathématiques</option>
                    <option>Français</option>
                    <option>Anglais</option>
                    <option>Histoire</option>
                    <option>Sciences</option>
                    <option>Informatique</option>
                  </select>
                </div>
              </div>

              <div class="form-row" style="margin-top:10px">
                <div>
                  <label for="nom">Nom</label>
                  <input id="nom" type="text" placeholder="Nom de famille" required />
                </div>
                <div>
                  <label for="prenom">Prénom</label>
                  <input id="prenom" type="text" placeholder="Prénom" required />
                </div>
              </div>

              <div class="form-row" style="margin-top:10px">
                <div>
                  <label for="age">Âge</label>
                  <input id="age" type="number" min="10" max="99" placeholder="Âge" required />
                </div>
                <div>
                  <label for="adresse">Adresse (laisser vide pour adresse aléatoire)</label>
                  <input id="adresse" type="text" placeholder="Ex: Delmas 33, Pétion-Ville..." />
                </div>
              </div>

              <div style="display:flex;gap:8px;margin-top:10px;align-items:center">
                <button type="button" id="randomAddrBtn" class="btn" style="background:#6b7280"><i class="fas fa-random"></i> Adresse aléatoire</button>
                <button type="submit" class="btn" id="addStudentBtn"><i class="fas fa-plus"></i> Ajout à la liste</button>
              </div>
            </form>
          </div>

          <div class="card">
            <h3 style="margin:0 0 8px 0;color:var(--accent)">Aide</h3>
            <p class="small-muted" style="margin:0">Le bouton "Ajout à la liste" ajoutera l'élève et vous redirigera automatiquement vers l'onglet Listes où le compteur en haut sera mis à jour.</p>
            <p class="small-muted" style="margin-top:6px">Cliquez "Adresse aléatoire" pour remplir automatiquement l'adresse avec une valeur (Delmas 33, Delmas 32, Delmas 75, Delmas 83, Pétion-Ville, Tabarre).</p>
          </div>
        </div>
      </section>

      <!-- ===== LISTES ===== -->
      <section id="listes-content" class="content-section" style="display:none">
        <h3 style="color:var(--accent);margin:0 0 10px 0">Listes des élèves — BIWI (Port-au-Prince)</h3>

        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;gap:12px">
          <div>
            <div class="small-muted">Élèves inscrits</div>
            <div class="count-badge" id="studentsCount">0</div>
          </div>
          <div style="display:flex;gap:8px;align-items:center;">
            <input id="tableFilter" placeholder="Filtrer la table (nom, prénom, cours, section, adresse)" aria-label="Filtrer la table" />
            <button class="btn" id="clearFilterBtn"><i class="fas fa-eraser"></i> Effacer</button>
          </div>
        </div>

        <div class="clients card" role="table" aria-label="Liste des élèves">
          <table id="studentsTable" aria-live="polite">
            <thead>
              <tr>
                <th>Section</th>
                <th>Nom</th>
                <th>Prénom</th>
                <th>Cours</th>
                <th>Âge</th>
                <th>Adresse</th>
                <!-- NEW Notes column -->
                <th>Notes</th>
              </tr>
            </thead>
            <tbody id="studentsBody">
              <!-- Rows by script -->
            </tbody>
          </table>
        </div>
      </section>

      <!-- ===== NOTES (NEW) ===== -->
      <section id="notes-content" class="content-section" style="display:none">
        <h3 style="color:var(--accent);margin:0 0 10px 0">Notes — Rechercher un élève</h3>

        <div class="card" style="margin-bottom:12px">
          <label for="notesSearch">Rechercher par Nom, Prénom, Cours, Section, Adresse</label>
          <input id="notesSearch" placeholder="Ex : Jean, Informatique, Section A" aria-label="Recherche de notes" />
          <small class="small-muted" style="display:block;margin-top:8px">Cliquez sur un élève ci-dessous pour ouvrir sa fiche de notes (générée aléatoirement à chaque ouverture).</small>
        </div>

        <div class="clients card" role="region" aria-label="Résultats de recherche de notes">
          <table aria-live="polite">
            <thead>
              <tr>
                <th>Section</th><th>Nom</th><th>Prénom</th><th>Cours</th><th>Âge</th><th>Adresse</th><th>Action</th>
              </tr>
            </thead>
            <tbody id="notesResultsBody">
              <!-- Matches here -->
            </tbody>
          </table>
        </div>
      </section>

      <!-- ===== RECHERCHE ===== -->
      <section id="recherche-content" class="content-section" style="display:none">
        <h3 style="color:var(--accent);margin:0 0 10px 0">Recherche rapide</h3>

        <div class="card" style="margin-bottom:12px">
          <label for="quickSearch">Rechercher par Nom, Prénom, Cours, Section, Adresse</label>
          <input id="quickSearch" placeholder="Ex : Jean, Mathématiques, Section A" aria-label="Recherche rapide" />
          <small class="small-muted" style="display:block;margin-top:8px">Résultats en temps réel depuis la liste complète.</small>
        </div>

        <div class="clients card" role="region" aria-label="Résultats de recherche">
          <table aria-live="polite">
            <thead>
              <tr>
                <th>Section</th><th>Nom</th><th>Prénom</th><th>Cours</th><th>Âge</th><th>Adresse</th>
              </tr>
            </thead>
            <tbody id="searchResultsBody">
              <!-- Matches here -->
            </tbody>
          </table>
        </div>
      </section>

      <!-- ===== PARAMÈTRES ===== -->
      <section id="parametres-content" class="content-section" style="display:none">
        <h3 style="color:var(--accent);margin:0 0 10px 0">Paramètres</h3>

        <div class="settings-grid" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:12px">
          <div class="card">
            <h4 style="color:var(--accent);margin:0 0 8px 0">Préférences</h4>
            <p class="small-muted">Notifications Email <label class="switch" style="margin-left:8px"><input id="notifEmail" type="checkbox" checked><span class="slider"></span></label></p>
            <p class="small-muted">Notifications SMS <label class="switch" style="margin-left:8px"><input id="notifSMS" type="checkbox"><span class="slider"></span></label></p>
            <p class="small-muted">Rapports hebdomadaires <label class="switch" style="margin-left:8px"><input id="weeklyReport" type="checkbox" checked><span class="slider"></span></label></p>
          </div>

          <div class="card">
            <h4 style="color:var(--accent);margin:0 0 8px 0">Thème</h4>
            <p class="small-muted" style="margin-bottom:8px">Mode sombre</p>
            <label class="switch"><input id="themeToggle" type="checkbox"><span class="slider"></span></label>
          </div>

          <div class="card">
            <h4 style="color:var(--accent);margin:0 0 8px 0">Paramètres aléatoires</h4>
            <p class="small-muted">Langue : Français</p>
            <p class="small-muted">Devise : Gourdes (G)</p>
            <p class="small-muted">Backup : Activé</p>
          </div>
        </div>
      </section>

      <footer>© 2025 BIWI — Tous droits réservés • Données exemple (Port-au-Prince)</footer>
    </main>
  </div>

  <!-- Notes popup (small custom card) -->
  <div class="notes-popup" id="notesPopup" aria-hidden="true">
    <div class="notes-card" role="dialog" aria-modal="false" id="notesCard">
      <button class="notes-close" id="notesClose" aria-label="Fermer"><i class="fas fa-times"></i></button>
      <h4 id="notesTitle">Notes</h4>
      <div id="notesBody" style="margin-top:8px;color:var(--muted)"></div>
    </div>
  </div>

  <!-- Modal overlay -->
  <div class="overlay" id="overlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <h3 id="modalTitle">Profil élève</h3>
      <div style="margin-top:8px;color:var(--muted)" id="modalSub">Information complète</div>

      <div style="margin-top:12px">
        <div class="row">
          <div>
            <label>Section</label>
            <input id="m_section" readonly />
          </div>
          <div>
            <label>Nom</label>
            <input id="m_nom" readonly />
          </div>
        </div>

        <div class="row">
          <div>
            <label>Prénom</label>
            <input id="m_prenom" readonly />
          </div>
          <div>
            <label>Cours</label>
            <input id="m_cours" readonly />
          </div>
        </div>

        <div class="row">
          <div>
            <label>Âge</label>
            <input id="m_age" type="number" readonly />
          </div>
          <div>
            <label>Adresse</label>
            <input id="m_adresse" readonly />
          </div>
        </div>

        <div style="margin-top:8px">
          <label>Date d'inscription</label>
          <input id="m_regdate" readonly />
        </div>

        <div class="actions">
          <button class="btn-ghost" id="modalClose"><i class="fas fa-times"></i> Fermer</button>
          <button class="btn-ghost" id="modalEdit"><i class="fas fa-pen"></i> Éditer</button>
          <button class="btn-save" id="modalSave"><i class="fas fa-save"></i> Sauvegarder</button>
          <button class="btn-danger" id="modalDelete"><i class="fas fa-trash"></i> Supprimer</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast" role="status" aria-live="polite"></div>

  <script>
    /* ----------------- Address options & helper functions ----------------- */
    const addressOptions = [
      'Delmas 33, Port-au-Prince, Haiti',
      'Delmas 32, Port-au-Prince, Haiti',
      'Delmas 75, Port-au-Prince, Haiti',
      'Delmas 83, Port-au-Prince, Haiti',
      'Pétion-Ville, Port-au-Prince, Haiti',
      'Tabarre, Port-au-Prince, Haiti'
    ];

    function randomAddress(){ return addressOptions[Math.floor(Math.random()*addressOptions.length)]; }
    function randomDate2025(){
      // random date between Jan 1 2025 and Dec 31 2025
      const start = new Date('2025-01-01T00:00:00Z').getTime();
      const end = new Date('2025-12-31T23:59:59Z').getTime();
      return new Date(start + Math.random()*(end-start));
    }
    function formatDate(d){
      if(!d) return '';
      const dt = new Date(d);
      const yyyy = dt.getFullYear();
      const mm = String(dt.getMonth()+1).padStart(2,'0');
      const dd = String(dt.getDate()).padStart(2,'0');
      const hh = String(dt.getHours()).padStart(2,'0');
      const min = String(dt.getMinutes()).padStart(2,'0');
      return `${dd}/${mm}/${yyyy} ${hh}:${min}`;
    }
    function uid(){ return 'id_' + Math.random().toString(36).slice(2,9); }

    /* ----------------- Initial students (with random reg date) ----------------- */
    const initial = [
      {section:'A', nom:'Baptiste', prenom:'Jean', cours:'Mathématiques', age:18},
      {section:'B', nom:'Rose', prenom:'Marie', cours:'Français', age:17},
      {section:'A', nom:'Louis', prenom:'Pierre', cours:'Anglais', age:19},
      {section:'C', nom:'Jean', prenom:'Nadège', cours:'Histoire', age:20},
      {section:'B', nom:'Toussaint', prenom:'Fabrice', cours:'Sciences', age:21},
      {section:'D', nom:'Bélance', prenom:'Sonia', cours:'Informatique', age:18},
      {section:'C', nom:'Michel', prenom:'Frantz', cours:'Mathématiques', age:22},
      {section:'A', nom:'Étienne', prenom:'Roseline', cours:'Français', age:16},
      {section:'B', nom:'Joseph', prenom:'Wilner', cours:'Anglais', age:23},
      {section:'C', nom:'Saintvil', prenom:'Mireille', cours:'Histoire', age:17},
      {section:'D', nom:'Pierre', prenom:'Kervens', cours:'Sciences', age:19},
      {section:'A', nom:'François', prenom:'Judith', cours:'Informatique', age:20},
      {section:'B', nom:'Augustin', prenom:'Ronald', cours:'Mathématiques', age:24},
      {section:'C', nom:'Marcelin', prenom:'Evelyne', cours:'Français', age:18},
      {section:'D', nom:'Fleurin', prenom:'Stephenson', cours:'Anglais', age:21},
      {section:'A', nom:'Prosper', prenom:'Carline', cours:'Histoire', age:17},
      {section:'B', nom:'Saintil', prenom:'Jodel', cours:'Sciences', age:19},
      {section:'C', nom:'Dorcé', prenom:'Vanessa', cours:'Informatique', age:20},
      {section:'D', nom:'Gérard', prenom:'Rony', cours:'Mathématiques', age:22},
      {section:'A', nom:'Étienne', prenom:'Keila', cours:'Français', age:16}
    ];

    // full students array with id, address, and registrationDate
    const students = initial.map(s => ({
      id: uid(),
      ...s,
      adresse: randomAddress(),
      regDate: randomDate2025()
    }));

    // DOM refs
    const studentsBody = document.getElementById('studentsBody');
    const studentsCount = document.getElementById('studentsCount');
    const dashboardTotal = document.getElementById('dashboardTotal');
    const tableFilter = document.getElementById('tableFilter');
    const clearFilterBtn = document.getElementById('clearFilterBtn');
    const searchResultsBody = document.getElementById('searchResultsBody');
    const quickSearch = document.getElementById('quickSearch');

    /* ----------------- Navigation & initial state ----------------- */
    document.querySelectorAll('nav.nav button').forEach(btn=>{
      btn.addEventListener('click', function(){
        document.querySelectorAll('nav.nav button').forEach(b=>b.classList.remove('active'));
        this.classList.add('active');
        const section = this.getAttribute('data-section');
        document.querySelectorAll('.content-section').forEach(s=>s.style.display='none');
        const el = document.getElementById(section + '-content');
        if(el) el.style.display = 'block';
        document.querySelector('.title h2').textContent = this.textContent.trim();
        if(window.innerWidth <= 980) document.getElementById('sidebar').classList.remove('open');

        if(section === 'listes') {
          tableFilter.value = '';
          renderStudentsTable(students);
        }
        if(section === 'dashboard') updateDashboard();
        if(section === 'recherche') { quickSearch.value = ''; renderSearchResults([]); }
        if(section === 'notes') { document.getElementById('notesSearch').value = ''; renderNotesResults([]); }
      });
    });

    document.querySelectorAll('.content-section').forEach(s=>s.style.display='none');
    document.getElementById('dashboard-content').style.display='block';

    document.getElementById('hamburger').addEventListener('click', ()=> document.getElementById('sidebar').classList.toggle('open'));

    /* ----------------- Render table (row click opens modal) ----------------- */
    function renderStudentsTable(list){
      studentsBody.innerHTML = '';
      if(!list.length){
        studentsBody.innerHTML = '<tr><td colspan="7" style="color:var(--muted)">Aucun élève trouvé.</td></tr>';
      } else {
        const frag = document.createDocumentFragment();
        list.forEach(s=>{
          const tr = document.createElement('tr');
          tr.classList.add('clickable');
          tr.setAttribute('data-id', s.id);
          tr.innerHTML = `<td><span class="tag">${escapeHtml(s.section)}</span></td>
                          <td>${escapeHtml(s.nom)}</td>
                          <td>${escapeHtml(s.prenom)}</td>
                          <td>${escapeHtml(s.cours)}</td>
                          <td>${escapeHtml(String(s.age))}</td>
                          <td>${escapeHtml(s.adresse)}</td>
                          <td><button class="notes-table-btn" data-id="${s.id}" title="Voir notes"><i class="fas fa-sticky-note"></i> Voir</button></td>`;
          // click to open modal (student profile)
          tr.addEventListener('click', ()=> openModal(s.id));
          frag.appendChild(tr);
        });
        studentsBody.appendChild(frag);

        // attach notes buttons (stop propagation so modal doesn't open)
        document.querySelectorAll('.notes-table-btn').forEach(b=>{
          b.addEventListener('click', function(e){
            e.stopPropagation();
            const id = this.getAttribute('data-id');
            openNotes(id);
          });
        });
      }
      studentsCount.textContent = students.length;
      dashboardTotal.textContent = students.length;
    }

    function escapeHtml(str){
      return String(str).replace(/[&<>"']/g, function(m){ return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]; });
    }

    renderStudentsTable(students);

    /* ----------------- Filters & search ----------------- */
    tableFilter.addEventListener('input', function(){
      const q = this.value.trim().toLowerCase();
      if(!q){ renderStudentsTable(students); return; }
      const filtered = students.filter(s => {
        return s.nom.toLowerCase().includes(q) ||
               s.prenom.toLowerCase().includes(q) ||
               s.cours.toLowerCase().includes(q) ||
               s.section.toLowerCase().includes(q) ||
               s.adresse.toLowerCase().includes(q);
      });
      renderStudentsTable(filtered);
    });
    clearFilterBtn.addEventListener('click', ()=> { tableFilter.value = ''; renderStudentsTable(students); });

    quickSearch && quickSearch.addEventListener('input', function(){
      const q = this.value.trim().toLowerCase();
      if(!q){ renderSearchResults([]); return; }
      const matches = students.filter(s => {
        return s.nom.toLowerCase().includes(q) ||
               s.prenom.toLowerCase().includes(q) ||
               s.cours.toLowerCase().includes(q) ||
               s.section.toLowerCase().includes(q) ||
               s.adresse.toLowerCase().includes(q);
      });
      renderSearchResults(matches);
    });

    function renderSearchResults(list){
      searchResultsBody.innerHTML = '';
      if(!list.length){
        searchResultsBody.innerHTML = '<tr><td colspan="6" style="color:var(--muted)">Aucun résultat.</td></tr>';
        return;
      }
      const frag = document.createDocumentFragment();
      list.forEach(s=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${escapeHtml(s.section)}</td>
                        <td>${escapeHtml(s.nom)}</td>
                        <td>${escapeHtml(s.prenom)}</td>
                        <td>${escapeHtml(s.cours)}</td>
                        <td>${escapeHtml(String(s.age))}</td>
                        <td>${escapeHtml(s.adresse)}</td>`;
        frag.appendChild(tr);
      });
      searchResultsBody.appendChild(frag);
    }

    /* ----------------- NOTES page search & rendering ----------------- */
    const notesSearch = document.getElementById('notesSearch');
    const notesResultsBody = document.getElementById('notesResultsBody');
    const notesPopup = document.getElementById('notesPopup');
    const notesTitle = document.getElementById('notesTitle');
    const notesBody = document.getElementById('notesBody');
    const notesClose = document.getElementById('notesClose');

    notesSearch && notesSearch.addEventListener('input', function(){
      const q = this.value.trim().toLowerCase();
      if(!q){ renderNotesResults([]); return; }
      const matches = students.filter(s => {
        return s.nom.toLowerCase().includes(q) ||
               s.prenom.toLowerCase().includes(q) ||
               s.cours.toLowerCase().includes(q) ||
               s.section.toLowerCase().includes(q) ||
               s.adresse.toLowerCase().includes(q);
      });
      renderNotesResults(matches);
    });

    function renderNotesResults(list){
      notesResultsBody.innerHTML = '';
      if(!list.length){
        notesResultsBody.innerHTML = '<tr><td colspan="7" style="color:var(--muted)">Aucun résultat.</td></tr>';
        return;
      }
      const frag = document.createDocumentFragment();
      list.forEach(s=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${escapeHtml(s.section)}</td>
                        <td>${escapeHtml(s.nom)}</td>
                        <td>${escapeHtml(s.prenom)}</td>
                        <td>${escapeHtml(s.cours)}</td>
                        <td>${escapeHtml(String(s.age))}</td>
                        <td>${escapeHtml(s.adresse)}</td>
                        <td><button class="notes-table-btn" data-id="${s.id}"><i class="fas fa-sticky-note"></i> Voir</button></td>`;
        frag.appendChild(tr);
      });
      notesResultsBody.appendChild(frag);

      // attach actions
      document.querySelectorAll('#notesResultsBody .notes-table-btn').forEach(b=>{
        b.addEventListener('click', function(e){
          const id = this.getAttribute('data-id');
          openNotes(id);
        });
      });
    }

    notesClose.addEventListener('click', ()=> closeNotes());

    function openNotes(id){
      const s = students.find(x=>x.id===id);
      if(!s) return;
      // generate random notes each time
      const notes = generateRandomNotes();
      // build HTML
      notesTitle.textContent = `${s.nom} ${s.prenom} — ${s.cours}`;
      let html = `<div style="color:var(--muted);font-size:13px;margin-bottom:8px">Section: ${escapeHtml(s.section)} • Adresse: ${escapeHtml(s.adresse)}</div>`;
      notes.forEach((yr, idx)=>{
        html += `<div class="notes-year"><div style="font-weight:800">${yr.label}</div>`;
        yr.subjects.forEach(sub=>{
          html += `<div class="subject">${escapeHtml(sub.name)} : ${sub.score}/100</div>`;
        });
        html += `<div class="result">Résultat : ${yr.avg}/100 ${yr.passed ? '<span style="color:var(--accent)">(Passé)</span>' : '<span style="color:#ef4444">(Échoué)</span>'}</div>`;
        html += `</div>`;
      });
      notesBody.innerHTML = html;
      notesPopup.classList.add('open');
      notesPopup.setAttribute('aria-hidden','false');
    }

    function closeNotes(){
      notesPopup.classList.remove('open');
      notesPopup.setAttribute('aria-hidden','true');
      notesBody.innerHTML = '';
    }

    function generateRandomNotes(){
      // subjects are fixed per year (like your example), but scores are random each time.
      const year1Subjects = ['Français','Bureautique','Microsoft Office'];
      const year2Subjects = ['Database','Website','Réseaux'];
      function randScore(){ return Math.floor(Math.random()*66)+30; } // 30 - 95
      const y1 = year1Subjects.map(name => ({name, score: randScore()}));
      const y2 = year2Subjects.map(name => ({name, score: randScore()}));
      const avg1 = Math.round(y1.reduce((a,b)=>a+b.score,0)/y1.length);
      const avg2 = Math.round(y2.reduce((a,b)=>a+b.score,0)/y2.length);
      return [
        { label: '1ère année', subjects: y1, avg: avg1, passed: avg1 >= 60 },
        { label: '2ème année', subjects: y2, avg: avg2, passed: avg2 >= 60 }
      ];
    }

    /* ----------------- Inscription (new student gets current reg date) ----------------- */
    const inscriptionForm = document.getElementById('inscriptionForm');
    const randomAddrBtn = document.getElementById('randomAddrBtn');
    const adresseInput = document.getElementById('adresse');

    randomAddrBtn.addEventListener('click', ()=>{
      adresseInput.value = randomAddress();
      adresseInput.focus();
    });

    inscriptionForm.addEventListener('submit', function(e){
      e.preventDefault();
      const sec = document.getElementById('section').value.trim();
      const cours = document.getElementById('cours').value.trim();
      const nom = document.getElementById('nom').value.trim();
      const prenom = document.getElementById('prenom').value.trim();
      const age = parseInt(document.getElementById('age').value, 10);
      let adresse = document.getElementById('adresse').value.trim();

      if(!nom || !prenom || isNaN(age)){ alert('Veuillez remplir correctement tous les champs.'); return; }
      if(age < 10 || age > 99){ alert('Âge invalide.'); return; }

      if(!adresse || adresse.toLowerCase().includes('port-au-prince')) adresse = randomAddress();

      const newStudent = {
        id: uid(),
        section: sec,
        nom: capitalize(nom),
        prenom: capitalize(prenom),
        cours,
        age,
        adresse,
        regDate: new Date() // current date/time for new students
      };
      students.unshift(newStudent);

      alert('Inscription envoyée et ajoutée à la liste.');
      // switch to Listes
      document.querySelector('[data-section="listes"]').click();
      renderStudentsTable(students);
      updateDashboard();
      inscriptionForm.reset();
      document.getElementById('section').value = 'A';
      document.getElementById('cours').value = 'Mathématiques';
    });

    function capitalize(s){ return s.charAt(0).toUpperCase() + s.slice(1).toLowerCase(); }

    /* ----------------- Modal logic (open, edit, save, delete) ----------------- */
    const overlay = document.getElementById('overlay');
    const modalClose = document.getElementById('modalClose');
    const modalEdit = document.getElementById('modalEdit');
    const modalSave = document.getElementById('modalSave');
    const modalDelete = document.getElementById('modalDelete');
    // inputs
    const m_section = document.getElementById('m_section');
    const m_nom = document.getElementById('m_nom');
    const m_prenom = document.getElementById('m_prenom');
    const m_cours = document.getElementById('m_cours');
    const m_age = document.getElementById('m_age');
    const m_adresse = document.getElementById('m_adresse');
    const m_regdate = document.getElementById('m_regdate');
    let currentModalId = null;
    let editing = false;

    function openModal(id){
      currentModalId = id;
      const s = students.find(x => x.id === id);
      if(!s) return;
      // populate
      m_section.value = s.section;
      m_nom.value = s.nom;
      m_prenom.value = s.prenom;
      m_cours.value = s.cours;
      m_age.value = s.age;
      m_adresse.value = s.adresse;
      m_regdate.value = formatDate(s.regDate);
      setModalReadonly(true);
      overlay.classList.add('open');
      overlay.setAttribute('aria-hidden','false');
    }

    function closeModal(){
      overlay.classList.remove('open');
      overlay.setAttribute('aria-hidden','true');
      currentModalId = null;
      editing = false;
      setModalReadonly(true);
    }

    modalClose.addEventListener('click', closeModal);
    overlay.addEventListener('click', function(e){
      if(e.target === overlay) closeModal();
    });

    function setModalReadonly(isReadOnly){
      editing = !isReadOnly;
      [m_section,m_nom,m_prenom,m_cours,m_age,m_adresse].forEach(inp=>{
        inp.readOnly = isReadOnly;
        inp.style.borderStyle = isReadOnly ? 'solid' : 'solid';
        // subtle visual change
        inp.style.background = isReadOnly ? 'transparent' : 'rgba(255,255,255,0.02)';
      });
      // toggle buttons visibility
      modalEdit.style.display = isReadOnly ? 'inline-block' : 'none';
      modalSave.style.display = isReadOnly ? 'none' : 'inline-block';
    }

    modalEdit.addEventListener('click', ()=> setModalReadonly(false));

    modalSave.addEventListener('click', ()=>{
      if(!currentModalId) return;
      const idx = students.findIndex(s => s.id === currentModalId);
      if(idx === -1) { showToast('Élève introuvable.', true); return; }
      // validation
      const newSec = m_section.value.trim();
      const newNom = m_nom.value.trim();
      const newPrenom = m_prenom.value.trim();
      const newCours = m_cours.value.trim();
      const newAge = parseInt(m_age.value, 10);
      const newAddr = m_adresse.value.trim();
      if(!newNom || !newPrenom || isNaN(newAge)){ showToast('Remplissez correctement les champs.', true); return; }
      if(newAge < 10 || newAge > 99){ showToast('Âge invalide.', true); return; }

      // save
      students[idx].section = newSec;
      students[idx].nom = capitalize(newNom);
      students[idx].prenom = capitalize(newPrenom);
      students[idx].cours = newCours;
      students[idx].age = newAge;
      students[idx].adresse = newAddr || randomAddress();

      setModalReadonly(true);
      renderStudentsTable(students);
      updateDashboard();
      showToast('Modifications enregistrées.');
    });

    // delete with confirmation dialog (custom confirm)
    modalDelete.addEventListener('click', ()=> {
      if(!currentModalId) return;
      const s = students.find(x=>x.id===currentModalId);
      if(!s) return;
      const ok = confirm(`Voulez-vous vraiment supprimer cet élève ?\n\n${s.nom} ${s.prenom}\n${s.adresse}`);
      if(!ok) return;
      // remove
      const idx = students.findIndex(x=>x.id===currentModalId);
      if(idx !== -1) students.splice(idx,1);
      renderStudentsTable(students);
      updateDashboard();
      closeModal();
      showToast('Élève supprimé avec succès.');
    });

    /* ----------------- Chart.js interactive charts ----------------- */
    let courseChart, sectionChart, addressChart;
    function updateCharts(){
      const courseCounts = {};
      const sectionCounts = {};
      const addressCounts = {};

      students.forEach(s=>{
        courseCounts[s.cours] = (courseCounts[s.cours]||0) + 1;
        sectionCounts[s.section] = (sectionCounts[s.section]||0) + 1;
        addressCounts[s.adresse] = (addressCounts[s.adresse]||0) + 1;
      });

      const courseLabels = Object.keys(courseCounts);
      const courseData = Object.values(courseCounts);

      const ctxCourse = document.getElementById('courseChart').getContext('2d');
      if(courseChart) courseChart.destroy();
      courseChart = new Chart(ctxCourse, {
        type: 'bar',
        data: { labels: courseLabels, datasets:[{ label: 'Nombre d\'élèves', data: courseData, backgroundColor: generateColors(courseLabels.length) }]},
        options:{responsive:true, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true, precision:0}}}
      });

      const sectionLabels = Object.keys(sectionCounts);
      const sectionData = Object.values(sectionCounts);
      const ctxSection = document.getElementById('sectionChart').getContext('2d');
      if(sectionChart) sectionChart.destroy();
      sectionChart = new Chart(ctxSection, { type:'doughnut', data:{labels:sectionLabels,datasets:[{data:sectionData, backgroundColor: generateColors(sectionLabels.length)}]}, options:{responsive:true} });

      const addressLabels = Object.keys(addressCounts);
      const addressData = Object.values(addressCounts);
      const ctxAddress = document.getElementById('addressChart').getContext('2d');
      if(addressChart) addressChart.destroy();
      addressChart = new Chart(ctxAddress, { type:'pie', data:{labels:addressLabels,datasets:[{data:addressData, backgroundColor: generateColors(addressLabels.length)}]}, options:{responsive:true} });
    }

    function generateColors(n){
      const palette = ['#0b74da','#00a86b','#ff7043','#8e44ad','#f1c40f','#2ecc71','#e74c3c','#3498db'];
      const out = [];
      for(let i=0;i<n;i++) out.push(palette[i%palette.length]);
      return out;
    }

    function updateDashboard(){
      document.getElementById('dashboardTotal').textContent = students.length;
      updateCharts();
    }

    // initial charts
    updateDashboard();

    /* ----------------- Theme toggle (persist) ----------------- */
    const themeToggle = document.getElementById('themeToggle');
    const saved = localStorage.getItem('biwi_theme');
    if(saved === 'dark'){ document.body.classList.add('dark'); themeToggle.checked = true; } else { document.body.classList.remove('dark'); themeToggle.checked = false; }
    themeToggle.addEventListener('change', function(){ if(this.checked){ document.body.classList.add('dark'); localStorage.setItem('biwi_theme','dark'); } else { document.body.classList.remove('dark'); localStorage.setItem('biwi_theme','light'); } updateCharts(); });

    /* ----------------- Toast helper ----------------- */
    const toast = document.getElementById('toast');
    let toastTimer = null;
    function showToast(message, isError=false){
      toast.textContent = message;
      toast.style.background = isError ? 'rgba(220,38,38,0.95)' : 'rgba(2,6,23,0.9)';
      toast.classList.add('show');
      if(toastTimer) clearTimeout(toastTimer);
      toastTimer = setTimeout(()=>{ toast.classList.remove('show'); }, 3200);
    }

    /* ----------------- Other helpers ----------------- */
    function uid(){ return 'id_' + Math.random().toString(36).slice(2,9); }

    // keep charts updated when students length changes
    const observer = new MutationObserver(()=> updateCharts());
    observer.observe(document.getElementById('studentsCount'), { childList:true });

    // initial focus for form
    document.getElementById('nom').focus();

    // expose some functions for debugging
    window.biwi = { students, refresh: ()=>{ renderStudentsTable(students); updateDashboard(); } };
  </script>
</body>
</html>
